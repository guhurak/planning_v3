<% week_days = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"] %>


<%= @month_selected %> <%= @year_selected %>
<div class="w-100 overflow-auto">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Utilisateur</th>
        <%
          actual_week = @weeks_more + 1
          day_in_the_week = @days_more + 1
          week_temp = actual_week.dup

          Time.days_in_month(@month_selected, @year_selected).times do
            unless week_temp == actual_week
              week_temp = actual_week.dup
            end %>
            <td class="pb-0 pt-0">
              <div class="position-relative m-0 align-middle text-center" style="min-height:51px;">
                <%= week_days[Date.new(@year_selected, @month_selected, day_in_the_week).wday - 1] %>
                <% if day_in_the_week == 1 %>
                  <span class="position-absolute" style="right:-10px;bottom:0px"><%= actual_week %></span>
                <% end %>
              </div>
            </td>
            <% day_in_the_week += 1

            if day_in_the_week > 7
              actual_week += 1
              day_in_the_week = 1
            end
            actual_week = 1 if actual_week > @weeks_nbr
          end
        %>
      </tr>
    </thead>

    <tbody>
      <% @users.each do |user| %>
        <tr>
          <th class="p-0"><div class="text-nowrap" style="padding:.75rem; height:49px;"><%= user.name %></div></th>
          <%
          actual_week = @weeks_more + 1
          day_in_the_week = @days_more + 1
          days = user.days.find_by(week: @weeks[actual_week - 1])
          week_temp = actual_week.dup

          Time.days_in_month(@month_selected, @year_selected).times do
            unless week_temp == actual_week
              assigns = user.days.find_by(week_id: @weeks[actual_week - 1]&.id)&.assigns
              if assigns
                days = JSON.parse(assigns)
              end
              week_temp = actual_week.dup
            end
            if days
              case day_in_the_week
              when 1
                day_name = days["mo"]
              when 2
                day_name = days["tu"]
              when 3
                day_name = days["we"]
              when 4
                day_name = days["th"]
              when 5
                day_name = days["fr"]
              when 6
                day_name = days["sa"]
              when 7
                day_name = days["su"]
              end
            else
              day_name = ""
            end %>
            <td><%= day_name %></td>
            <% day_in_the_week += 1

            if day_in_the_week > 7
              actual_week += 1
              day_in_the_week = 1
            end
            actual_week = 1 if actual_week > @weeks_nbr
          end %>
        </tr>
      <% end %>
      <% @assistants_count.times do %>
        <tr>
          <th class="p-0"><div class="w-100" style="height:49px;"></div></th>
          <% Time.days_in_month(@month_selected, @year_selected).times do %>
           <td></td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
